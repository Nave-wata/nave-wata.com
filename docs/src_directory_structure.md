# src ディレクトリ構造

このドキュメントでは、`src` ディレクトリの構造と各コンポーネントの役割について詳細に説明します。Nave-wataプロジェクトは、クリーンアーキテクチャの原則に従って構築されており、`src` ディレクトリはそのコアとなるソースコードを含んでいます。

## 全体構造

```
src/
├── Application/                   # アプリケーション層
│   ├── DTOs/                      # データ転送オブジェクト
│   ├── Handlers/                  # イベント/コマンドハンドラー
│   │   ├── Commands/              # コマンドとそのハンドラー
│   │   └── Queries/               # クエリとそのハンドラー
│   ├── Services/                  # アプリケーションサービス
│   └── UseCases/                  # ユースケース実装
├── Domain/                        # ドメイン層
│   ├── Aggregates/                # 集約ルート
│   ├── Entities/                  # エンティティ
│   ├── Events/                    # ドメインイベント
│   ├── Exceptions/                # ドメイン例外
│   ├── Repositories/              # リポジトリインターフェース
│   ├── Services/                  # ドメインサービス
│   └── ValueObjects/              # 値オブジェクト
├── Infrastructure/                # インフラストラクチャ層
│   ├── External/                  # 外部サービス連携
│   │   ├── APIs/                  # 外部APIクライアント
│   │   ├── Adapters/              # 外部サービスアダプター
│   │   └── Services/              # 外部サービス実装
│   ├── Persistence/               # データ永続化
│   │   ├── Entities/              # データベースエンティティ
│   │   ├── Migrations/            # データベースマイグレーション
│   │   └── Repositories/          # データベースリポジトリ実装
│   ├── Repositories/              # リポジトリ実装
│   └── Services/                  # インフラストラクチャサービス
├── Interfaces/                    # インターフェース層
│   ├── Controllers/               # コントローラー
│   ├── Middlewares/               # ミドルウェア
│   └── Presenters/                # プレゼンター
└── bootstrap.php                  # アプリケーション起動スクリプト
```

## 各層とコンポーネントの詳細

### 1. Application層 (`src/Application/`)

アプリケーション層は、ユースケースを実装し、ドメイン層のオブジェクトを調整する役割を持ちます。

#### DTOs/ (Data Transfer Objects)

- **役割**: レイヤー間のデータ転送用オブジェクトを提供します。
- **特徴**: エンティティの内部構造を隠蔽し、必要なデータのみを転送します。

#### Handlers/

- **役割**: イベントやコマンドを処理するハンドラーを提供します。
- **特徴**: 特定のイベントやコマンドに対する処理ロジックをカプセル化します。
- **サブディレクトリ**:

  ##### Commands/
  - **役割**: コマンドパターンを実装し、アプリケーションの状態を変更する操作を表現します。

  ##### Queries/
  - **役割**: クエリパターンを実装し、データの取得操作を表現します。

#### Services/

- **役割**: 複数のユースケースで共有される機能を提供します。
- **特徴**: ドメインサービスとは異なり、アプリケーション固有のロジックを含みます。

#### UseCases/

- **役割**: アプリケーションの特定の機能（ユースケース）を実装します。
- **特徴**: ドメインオブジェクトを調整し、アプリケーションのフローを制御します。

### 2. Domain層 (`src/Domain/`)

ドメイン層は、ビジネスロジックの中心部分を含み、他のレイヤーに依存しません。

#### Aggregates/

- **役割**: 関連するエンティティと値オブジェクトのクラスターを表す集約ルートを提供します。
- **特徴**: 一貫性の境界を定義し、外部からのアクセスポイントとなります。
- **説明**: 現在は空のディレクトリで、将来的に集約ルートの実装が追加される予定です。集約ルートは、関連するエンティティのグループを一つの単位として扱い、整合性を保証します。

#### Entities/

- **役割**: ビジネスオブジェクトとルールを表現します。
- **特徴**: 一意の識別子を持ち、ライフサイクルを通じて同一性を維持します。

#### Events/

- **役割**: ドメイン内で発生するイベントを表現します。
- **特徴**: 不変であり、過去に発生したことを表します。

#### Exceptions/

- **役割**: ドメイン固有の例外を提供します。
- **特徴**: ドメインルールの違反や無効な操作を表現します。

#### Repositories/

- **役割**: データアクセスの抽象化を提供します。
- **特徴**: ドメイン層がデータストレージの詳細に依存しないようにします。

#### Services/

- **役割**: エンティティに属さないドメインロジックを提供します。
- **特徴**: ステートレスであり、複数のエンティティに関連する操作を実行します。

#### ValueObjects/

- **役割**: 値とその振る舞いをカプセル化します。
- **特徴**: 不変であり、同じ属性を持つ2つの値オブジェクトは等価です。

### 3. Infrastructure層 (`src/Infrastructure/`)

インフラストラクチャ層は、技術的な実装の詳細を提供します。

#### External/

- **役割**: 外部サービスとの連携を担当します。
- **特徴**: APIクライアント、外部サービスアダプターなどを含みます。
- **サブディレクトリ**:

  ##### APIs/
  - **役割**: 外部APIとの通信を担当するクライアントを提供します。

  ##### Adapters/
  - **役割**: 外部サービスをドメインインターフェースに適合させるアダプターを提供します。

  ##### Services/
  - **役割**: 外部サービスの実装を提供します。

#### Persistence/

- **役割**: データの永続化を担当します。
- **特徴**: データベース接続、ORM設定などを含みます。
- **サブディレクトリ**:

  ##### Entities/
  - **役割**: データベースエンティティを提供します。

  ##### Migrations/
  - **役割**: データベーススキーマの変更を管理します。

  ##### Repositories/
  - **役割**: データベースを使用したリポジトリ実装を提供します。

#### Repositories/

- **役割**: ドメイン層で定義されたリポジトリインターフェースの実装を提供します。
- **特徴**: 具体的なデータストレージ技術（MySQL、MongoDB等）に依存します。

#### Services/

- **役割**: インフラストラクチャレベルのサービスを提供します。
- **特徴**: ログ記録、キャッシュ、ファイル操作などの技術的なサービスを含みます。

### 4. Interfaces層 (`src/Interfaces/`)

インターフェース層は、外部とのやり取りを担当します。

#### Controllers/

- **役割**: HTTPリクエストの処理を担当します。
- **特徴**: ルーティングとリクエスト/レスポンスの処理を行います。

#### Middlewares/

- **役割**: リクエスト処理の前後に実行される処理を提供します。
- **特徴**: 認証、ロギング、レスポンス変換などの横断的関心事を処理します。

#### Presenters/

- **役割**: ユースケースからのデータを表示用に整形します。
- **特徴**: HTML表示用とAPI用の異なる形式を提供します。

### bootstrap.php (ファイル)

- **役割**: アプリケーションの起動処理を担当します。
- **特徴**: 依存性注入コンテナの設定、ルートの登録、ミドルウェアの設定などを行います。
- **処理内容**:
  1. Composerオートローダーの読み込み
  2. アプリケーション設定の読み込み
  3. 依存性注入コンテナの作成
  4. Slimアプリケーションの作成
  5. Twigテンプレートエンジンの設定
  6. ルートの登録
  7. アプリケーションインスタンスの返却

## 依存関係の流れ

クリーンアーキテクチャの原則に従い、依存関係は常に外側から内側に向かいます：

```
Interfaces層 → Application層 → Domain層 ← Infrastructure層
```

この依存関係の方向性により、ドメイン層は他のレイヤーに依存せず、アプリケーションの中心となるビジネスロジックが技術的な実装の詳細から独立しています。

## まとめ

`src` ディレクトリは、クリーンアーキテクチャの原則に従って構造化されており、各レイヤーが明確に分離されています。この構造により、テスト容易性、保守性、拡張性の高いコードベースが実現されています。
